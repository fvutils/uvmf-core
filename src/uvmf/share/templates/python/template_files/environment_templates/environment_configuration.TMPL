{% set fname = "{{vip_location}}/{{environment_location}}/{{name}}_env_pkg/{{src_dir}}{{name}}_env_configuration.svh" %}
{% extends "base_template.TMPL" %}

{% block description %}
//----------------------------------------------------------------------
//                                          
// DESCRIPTION: THis is the configuration for the {{name}} environment.
//  it contains configuration classes for each agent.  It also contains
//  environment level configuration variables.
//
//----------------------------------------------------------------------
{% endblock %}

{% block contents %}
class {{name}}_env_configuration {{macro.paramDeclare(hvlParamDefs)|indent(13)}} 
extends uvmf_environment_configuration_base;

{{macro.objUtils([ name,'_env_configuration']|join(""),hvlPparamDefs)}}

{% for config in configVars %}
{% if config.comment|length > 0 %}  // {{config.comment}}
{% endif %}
  {% if config.isrand %}rand {% endif %}{{config.type}} {{config.name}}{% if config.unpackedDim != '' %} {{config.unpackedDim}} {% endif %}{% if config.value != '' %} = {{config.value}}{% endif %};
{% endfor %}

//Constraints for the configuration variables:
{% for cnstr in configVarsConstraints %}
{% if cnstr.comment|length > 0 %}  // {{cnstr.comment}}
{% endif %}
  constraint {{cnstr.name}} {{cnstr.type}}
{% endfor %}

{% for regModel in regModels %}
// Instantiate the register model
  {{regModel.regBlockClass}}  {{regModel.regBlockInstance}};
{% endfor %}

  covergroup {{name}}_configuration_cg;
    // pragma uvmf custom covergroup begin
    option.auto_bin_max=1024;
{% for config in configVars %}
{% if config.unpackedDim != '' %}//{% endif %}    coverpoint {{config.name}};
{% endfor %}
    // pragma uvmf custom covergroup end
  endgroup

{% for sub_env in subEnvironments %}
typedef {{sub_env.envPkg}}_env_configuration{{macro.paramUseNested(sub_env.hvlParameters)|indent(16)}} {{sub_env.name}}_config_t;
rand {{sub_env.name}}_config_t {{sub_env.name}}_config{% if sub_env.instanceArraySize != '' %}[]{% endif %};

{% endfor %}

{% for agent in agents %}
    typedef {{agent.ifPkg}}_configuration {{macro.paramUseNested(agent.hvlParameters)|indent(16)}} {{agent.name}}_config_t;
    rand {{agent.name}}_config_t {{agent.name}}_config{% if agent.instanceArraySize != '' %}[]{% endif %};

{% endfor %}

{% for sub_env in qvipSubEnvironments %}
  {{sub_env.envPkg}}_env_configuration     {{sub_env.name}}_config{% if sub_env.instanceArraySize != '' %}[]{% endif %};
{% endfor %}

{% if envHasComponentArrays == False %}
{% for sub_env in subEnvironments %}
  string                {{sub_env.name}}_interface_names[];
  uvmf_active_passive_t {{sub_env.name}}_interface_activity[];
{% endfor %}

{% for sub_env in qvipSubEnvironments %}
  string                                   {{sub_env.name}}_interface_names[];
  uvmf_active_passive_t                    {{sub_env.name}}_interface_activity[];
{% endfor %}
{% endif %}
  typedef uvmf_virtual_sequencer_base #(.CONFIG_T({{name}}_env_configuration)) {{name}}_vsqr_t;
  {{name}}_vsqr_t vsqr;

  // pragma uvmf custom class_item_additional begin
  // pragma uvmf custom class_item_additional end

// ****************************************************************************
// FUNCTION : new()
// This function is the standard SystemVerilog constructor.
// This function constructs the configuration object for each agent in the environment.
//
  function new( string name = "" );
    super.new( name );

{% for sub_env in subEnvironments %}
{% if sub_env.instanceArraySize != '' %}
    {{sub_env.name}}_config = new[1];
    {{sub_env.name}}_config[0] = {{sub_env.name}}_config_t::type_id::create($sformatf("{{sub_env.name}}_config_[%0d]",0));
{% else %}
    {{sub_env.name}}_config = {{sub_env.name}}_config_t::type_id::create("{{sub_env.name}}_config");
{% endif %}
{% endfor %}

{% for agent in agents %}
{% if agent.instanceArraySize != '' %}
    {{agent.name}}_config = new[1];
    {{agent.name}}_config[0] = {{agent.name}}_config_t::type_id::create($sformatf("{{agent.name}}_config_[%0d]",0));
{% else %}
    {{agent.name}}_config = {{agent.name}}_config_t::type_id::create("{{agent.name}}_config");
{% endif %}
{% endfor %}

{% for sub_env in qvipSubEnvironments %}
{% if sub_env.instanceArraySize != '' %}
    {{sub_env.name}}_config = new[1];
    {{sub_env.name}}_config[0] = {{sub_env.envPkg}}_env_configuration::type_id::create($sformatf("{{sub_env.name}}_config_[%0d]",0));
    end
{% else %}
    {{sub_env.name}}_config = {{sub_env.envPkg}}_env_configuration::type_id::create("{{sub_env.name}}_config");
{% endif %}
{% endfor %}

    {{name}}_configuration_cg=new;
    `uvm_warning("COVERAGE_MODEL_REVIEW", "A covergroup has been constructed which may need review because of either generation or re-generation with merging.  Please note that configuration variables added as a result of re-generation and merging are not automatically added to the covergroup.  Remove this warning after the covergroup has been reviewed.")

  // pragma uvmf custom new begin
  // pragma uvmf custom new end
  endfunction

// ****************************************************************************
// FUNCTION : set_vsqr()
// This function is used to assign the vsqr handle.
  virtual function void set_vsqr( {{name}}_vsqr_t vsqr);
     this.vsqr = vsqr;
  endfunction : set_vsqr

// ****************************************************************************
// FUNCTION: post_randomize()
// This function is automatically called after the randomize() function 
// is executed.
//
  function void post_randomize();
    super.post_randomize();
    // pragma uvmf custom post_randomize begin
    // pragma uvmf custom post_randomize end
  endfunction
  
// ****************************************************************************
// FUNCTION: convert2string()
// This function converts all variables in this class to a single string for
// logfile reporting. This function concatenates the convert2string result for
// each agent configuration in this configuration class.
//
  virtual function string convert2string();
    // pragma uvmf custom convert2string begin
{% if envHasComponentArrays == True %}

    string msg;

    msg = "\n{{name}}_env_configuration:\n";

     {% if configVars|length > 0 %}msg = {msg,$sformatf("{% for config in configVars %}{{config.name}}:0x%x {% endfor %}"{% for config in configVars %},{{config.name}}{% endfor %})};{% endif %}

{% for agent in agents %}
{% if agent.instanceArraySize != '' %}
     foreach ( {{agent.name}}_config[i] ) begin
       msg = {msg,$sformatf("\n{{agent.name}}_config_[%0d]:",i), {{agent.name}}_config[i].convert2string};
     end
{% else %}
     msg = {msg,"{{agent.name}}_config:\n", {{agent.name}}_config.convert2string};
{% endif %}
{% endfor %}

{% for subEnv in subEnvironments %}
 {% if subEnv.instanceArraySize != '' %}
     foreach ( {{subEnv.name}}_config[i] ) begin
       msg = {msg,$sformatf("\n{{subEnv.name}}_config_[%0d]:",i), {{subEnv.name}}_config[i].convert2string};
     end
{% else %}
    msg = {msg,"{{subEnv.name}}_config:\n", {{subEnv.name}}_config.convert2string};
{% endif %}
{% endfor %}

{% for sub_env in qvipSubEnvironments %}
 {% if sub_env.instanceArraySize != '' %}
     foreach ( {{sub_env.name}}_config[i] ) begin
       msg = {msg,$sformatf("\n{{sub_env.name}}_config_[%0d]:",i), {{sub_env.name}}_config[i].convert2string};
     end
{% else %}
    msg = {msg,"{{sub_env.name}}_config:\n", {{sub_env.name}}_config.convert2string};
{% endif %}
{% endfor %}

  return msg;

{% else %}
    return {
     {% if configVars|length > 0 %}$sformatf("{% for config in configVars %}{{config.name}}:0x%x {% endfor %}"{% for config in configVars %},{{config.name}}{% endfor %}){% if agents|length > 0 or subEnvironments|length > 0 or qvipSubEnvironments|length > 0 %},{% endif %}{% endif %}

{% for agent in agents %}
     "\n", {{agent.name}}_config.convert2string{% if not loop.last %},
{% endif %}{% endfor %}
{% if agents|length > 0 %}{% if subEnvironments|length > 0 or qvipSubEnvironments|length > 0 %},{% endif %}{% endif %}

{% for subEnv in subEnvironments %}
     "\n", {{subEnv.name}}_config.convert2string{% if not loop.last %},
{% endif %}
{% endfor %}
{% if subEnvironments|length > 0 %}{% if qvipSubEnvironments|length > 0 %},{% endif %}{% endif %}

{% for sub_env in qvipSubEnvironments %}
     "\n", {{sub_env.name}}_config.convert2string{% if not loop.last %},
{% endif %}
{% endfor %}

       };
{% endif %}
    // pragma uvmf custom convert2string end
  endfunction

{% if envHasComponentArrays == False %}
// ****************************************************************************
// FUNCTION: initialize();
// This function configures each interface agents configuration class.  The 
// sim level determines the active/passive state of the agent.  The environment_path
// identifies the hierarchy down to and including the instantiation name of the
// environment for this configuration class.  Each instance of the environment 
// has its own configuration class.  The string interface names are used by 
// the agent configurations to identify the virtual interface handle to pull from
// the uvm_config_db.  
// 
// NOTE - initialize() function is maintained only for backward compatibility
//
  function void initialize(uvmf_sim_level_t sim_level, 
                                      string environment_path,
                                      string interface_names[],
                                      uvm_reg_block register_model = null,
                                      uvmf_active_passive_t interface_activity[] = {}
                                     );

    super.initialize(sim_level, environment_path, interface_names, register_model, interface_activity);

{% if subEnvironments|length > 0 %}  // Interface initialization for sub-environments
{% endif %}
{% for sub_env in subEnvironments %}
{% if sub_env.numAgents > 0 %}
    {{sub_env.name}}_interface_names    = new[{{sub_env.numAgents}}];
    {{sub_env.name}}_interface_activity = new[{{sub_env.numAgents}}];

    {{sub_env.name}}_interface_names     = interface_names[{{sub_env.agentMinIndex}}:{{sub_env.agentMaxIndex}}];
    {{sub_env.name}}_interface_activity  = interface_activity[{{sub_env.agentMinIndex}}:{{sub_env.agentMaxIndex}}];
{% endif %}
{% endfor %}

{% if qvipSubEnvironments|length > 0 %}  // Interface initialization for QVIP sub-environments
{% endif %}
{% for sub_env in qvipSubEnvironments %}
    {{sub_env.name}}_interface_names    = new[{{sub_env.numAgents}}];
    {{sub_env.name}}_interface_activity = new[{{sub_env.numAgents}}];

    {{sub_env.name}}_interface_names     = interface_names[{{sub_env.agentMinIndex}}:{{sub_env.agentMaxIndex}}];
    {{sub_env.name}}_interface_activity  = interface_activity[{{sub_env.agentMinIndex}}:{{sub_env.agentMaxIndex}}];

{% endfor %}

{% if agents|length > 0 %}  // Interface initialization for local agents
{% endif %}
{% for agent in agents %}
     {{agent.name}}_config.initialize( interface_activity[{{agent.agentIndex}}], {environment_path,".{{agent.name}}"}, interface_names[{{agent.agentIndex}}]);
     {{agent.name}}_config.initiator_responder = {{agent.initResp}};
     // {{agent.name}}_config.has_coverage = 1;
{% endfor %}

{% for regModel in regModels %}
    // pragma uvmf custom reg_model_config_initialize begin
    // Register model creation and configuation
    if (register_model == null) begin
      {{regModel.regBlockInstance}} = {{regModel.regBlockClass}}::type_id::create("{{regModel.regBlockInstance}}");
      {{regModel.regBlockInstance}}.build();
      {{regModel.regBlockInstance}}.lock_model();
{% if regModel.adapterType != 'None' %}
      enable_reg_adaptation = {% if regModel.useAdapter %}1{% else %}0{% endif %};
{% endif %}
{% if regModel.transactionType != 'None' %}
      enable_reg_prediction = {% if regModel.useExplicitPrediction %}1{% else %}0{% endif %};
{% endif %}
    end else begin
      $cast({{regModel.regBlockInstance}},register_model);
{% if regModel.transactionType != 'None' %}
      enable_reg_prediction = {% if regModel.useExplicitPrediction %}1{% else %}0{% endif %};
{% endif %}
    end
    // pragma uvmf custom reg_model_config_initialize end
{% endfor %}

{% for sub_env in subEnvironments %}
     {{sub_env.name}}_config.initialize( sim_level, {environment_path,".{{sub_env.name}}"}, {{sub_env.name}}_interface_names, {% if ((sub_env.regModelPkg != None) and (regModels|length > 0)) %}{{regModels[0].regBlockInstance}}.{{sub_env.regBlockInstance}}{% else %}null{% endif %},   {{sub_env.name}}_interface_activity);
{% endfor %}

{% for sub_env in qvipSubEnvironments %}
     {{sub_env.name}}_config.initialize( sim_level, {environment_path,".{{sub_env.name}}"}, {{sub_env.name}}_interface_names, null,   {{sub_env.name}}_interface_activity);
{% endfor %}

{% for configVariable in configVariableValues %}
     {{configVariable.name}} = {{configVariable.value}};
{% endfor %}

  // pragma uvmf custom initialize begin
  // pragma uvmf custom initialize end

  endfunction
{% endif %}

// ****************************************************************************
// FUNCTION: setup();
// This function configures each interface agents configuration class.  
//
  function void setup(string hdl_path);
{% for agent in agents %}
{% if agent.instanceArraySize != '' %}
    {{agent.name}}_config_t tmp_{{agent.name}}_config;
{% endif %}
{% endfor %}
{% for sub_env in subEnvironments %}
{% if sub_env.instanceArraySize != '' %}
    {{sub_env.name}}_config_t tmp_{{sub_env.name}}_config;
{% endif %}
{% endfor %}
    // pragma uvmf custom setup_pre begin
    // pragma uvmf custom setup_pre end

{% for agent in agents %}
{% if agent.instanceArraySize != '' %}
    // Construct remaining elements of {{agent.name}} agent array
    tmp_{{agent.name}}_config = {{agent.name}}_config[0];
    {{agent.name}}_config = new[{{agent.instanceArraySize}}];
    {{agent.name}}_config[0] = tmp_{{agent.name}}_config;
    for ( int i=1; i< {{agent.instanceArraySize}}; i++) begin
      {{agent.name}}_config[i] = {{agent.name}}_config_t::type_id::create($sformatf("{{agent.name}}_config_[%0d]",0));
    end
{% endif %}
{% endfor %}

{% for sub_env in subEnvironments %}
{% if sub_env.instanceArraySize != '' %}
    // Construct remaining elements of {{sub_env.name}} subenv array
    tmp_{{sub_env.name}}_config = {{sub_env.name}}_config[0];
    {{sub_env.name}}_config=new[{{sub_env.instanceArraySize}}];
    {{sub_env.name}}_config[0] = tmp_{{sub_env.name}}_config;
    for ( int i=1; i< {{sub_env.instanceArraySize}}; i++) begin
      {{sub_env.name}}_config[i] = {{sub_env.name}}_config_t::type_id::create($sformatf("{{sub_env.name}}_config_[%0d]",i));
    end
{% endif %}
{% endfor %}

    // pragma uvmf custom setup_mid begin
    // pragma uvmf custom setup_mid end
{% if regModelPkg != None %}
    enable_reg_adaptation = 1;
    enable_reg_prediction = 1;
{% endif %}
{% for sub_env in subEnvironments %}
{% if sub_env.regModelPkg != None %}
    // Construct sub-environment register blocks for {{sub_env.name}}
{% if sub_env.instanceArraySize != '' %}
    {{regModels[0].regBlockInstance}}.{{sub_env.regBlockInstance}}=new[{{sub_env.instanceArraySize}}];
    for ( int i=0; i< {{sub_env.instanceArraySize}}; i++) begin
      {{regModels[0].regBlockInstance}}.{{sub_env.regBlockInstance}}[i]=new($sformatf("{{sub_env.regBlockInstance}}_[%0d]",i));
    end
{% else %}
    {{regModels[0].regBlockInstance}}.{{sub_env.regBlockInstance}}=new("{{sub_env.regBlockInstance}}");
{% endif %}
{% endif %}
{% endfor %}

{% for sub_env in subEnvironments %}
{% if sub_env.regModelPkg != None %}
    // Assign register blocks to sub-environment {{sub_env.name}}
{% if sub_env.instanceArraySize != '' %}
    for ( int i=0; i< {{sub_env.instanceArraySize}}; i++) begin
      {{sub_env.name}}_config[i].{{sub_env.envPkg}}_rm = 
      {{regModels[0].regBlockInstance}}.{{sub_env.regBlockInstance}}[i];
    end
{% else %}
    {{sub_env.name}}_config.{{sub_env.envPkg}}_rm = 
      {{regModels[0].regBlockInstance}}.{{sub_env.regBlockInstance}};
{% endif %}
{% endif %}
{% endfor %}

{% if agents|length > 0 %}
    // Call setup of agents
{% for agent in agents %}
{% if agent.instanceArraySize != '' %}
    foreach ({{agent.name}}_config[i]) begin
      {{agent.name}}_config[i].setup($sformatf("%s.%s[%0d].%s",hdl_path,"{{agent.name}}",i,"{{agent.name}}"));
      {{agent.name}}_config[i].initiator_responder = {{agent.initResp}};
     end
{% else %}
    {{agent.name}}_config.setup({hdl_path,".","{{agent.name}}"});
    {{agent.name}}_config.initiator_responder = {{agent.initResp}};
{% endif %}
{% endfor %}
{% endif %}

{% if subEnvironments|length > 0 %}
    // Call setup of sub-environments
{% for sub_env in subEnvironments %}
{% if sub_env.instanceArraySize != '' %}
    foreach ({{sub_env.name}}_config[i]) begin
      {{sub_env.name}}_config[i].setup({hdl_path,".","{{sub_env.name}}",$sformatf("[%0d]",i)});
{% if sub_env.regModelPkg != None %}
      {{sub_env.name}}_config[i].enable_reg_adaptation = 0;
      {{sub_env.name}}_config[i].enable_reg_prediction = 0;
{% endif %}
    end
{% else %}
    {{sub_env.name}}_config.setup({hdl_path,".","{{sub_env.name}}"});
{% if sub_env.regModelPkg != None %}
    {{sub_env.name}}_config.enable_reg_adaptation = 0;
    {{sub_env.name}}_config.enable_reg_prediction = 0;
{% endif %}{% endif %}
{% endfor %}
{% endif %}
    // pragma uvmf custom setup_post begin
    // pragma uvmf custom setup_post end

  endfunction
endclass

// pragma uvmf custom external begin
// pragma uvmf custom external end

{% endblock %}
